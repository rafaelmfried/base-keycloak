# Stage 1: build da extensão keycloak-orgs com JDK 21
FROM maven:3.9.8-eclipse-temurin-21 AS builder

# instala git e clona o repositório Phase Two (keycloak-orgs)
RUN apt-get update \
 && apt-get install -y git \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /build
RUN git clone https://github.com/p2-inc/keycloak-orgs.git \
 && cd keycloak-orgs \
 && mvn clean install -DskipTests

# Stage 2: imagem final do Keycloak com o provider instalado
FROM openjdk:21-slim

# Debug step to find the JAR file
COPY --from=builder /build /tmp/build
RUN find /tmp/build -name "*.jar" > /tmp/jar-locations.txt

# Copia o servidor Keycloak 26.2.4 e ativa Organizations
# ENV KC_FEATURES=organization
COPY --from=quay.io/keycloak/keycloak:26.2.4 /opt/keycloak /opt/keycloak

WORKDIR /opt/keycloak
ENTRYPOINT ["./bin/kc.sh", "start-dev", "--features", "organization"]